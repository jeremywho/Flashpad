name: Smoke Test

# Manual trigger only - won't run on push/PR
on:
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Platforms to test'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - android
          - web

jobs:
  ios:
    if: ${{ inputs.platforms == 'all' || inputs.platforms == 'ios' }}
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: cd packages/shared && npm run build

      - name: Install CocoaPods
        run: cd packages/mobile/ios && pod install

      - name: Build iOS app
        run: |
          cd packages/mobile/ios
          xcodebuild -workspace mobile.xcworkspace \
            -scheme mobile \
            -configuration Release \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=latest' \
            -derivedDataPath build \
            build

      - name: Boot simulator and launch app
        run: |
          # Boot simulator
          xcrun simctl boot "iPhone 16" || true

          # Install the app
          APP_PATH=$(find packages/mobile/ios/build -name "*.app" -type d | head -1)
          xcrun simctl install booted "$APP_PATH"

          # Launch app and check it doesn't crash immediately
          xcrun simctl launch booted cc.flashpad.mobile
          sleep 5

          # Check if app is still running (didn't crash)
          if xcrun simctl spawn booted launchctl list | grep -q flashpad; then
            echo "App launched successfully and is still running"
          else
            echo "App may have crashed"
            exit 1
          fi

  android:
    if: ${{ inputs.platforms == 'all' || inputs.platforms == 'android' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: cd packages/shared && npm run build

      - name: Enable KVM for Android emulator
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Build Android APK
        run: |
          cd packages/mobile/android
          ./gradlew assembleRelease

      - name: Run Android emulator and test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 34
          arch: x86_64
          profile: pixel_6
          script: |
            # Install APK
            adb install packages/mobile/android/app/build/outputs/apk/release/app-release.apk

            # Launch app
            adb shell am start -n cc.flashpad.mobile/.MainActivity
            sleep 10

            # Check if app is running
            if adb shell pidof cc.flashpad.mobile > /dev/null; then
              echo "App launched successfully"
            else
              echo "App crashed on startup"
              adb logcat -d | tail -100
              exit 1
            fi

  web:
    if: ${{ inputs.platforms == 'all' || inputs.platforms == 'web' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: cd packages/shared && npm run build

      - name: Build web app
        run: cd packages/web && npm run build

      - name: Check build output
        run: |
          if [ -f "packages/web/dist/index.html" ]; then
            echo "Web build successful"
            ls -la packages/web/dist/
          else
            echo "Web build failed - no index.html"
            exit 1
          fi
